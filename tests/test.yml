---
- hosts: test_machine
  become: yes

- hosts: test_machine
  become: yes

  vars:
    docker_volumes: /srv/docker
    docker_network_interface: 172.17.0.1

  pre_tasks:
    - apt:
        name: python3-pip
        update_cache: yes
    - pip:
        name: docker

  roles:
    - role: install-docker
      storage_driver: overlay2
      cleanup_enabled: true

    - role: install-docker-compose

    - role: ansible-nginx
#      image_version: 1.16.1-alpine
      clear_dh_parameter: no
      configs:
        gitlab:
          https: false
          upstreams:
            gitlab: "172.17.0.1:10080"
          server_name: git.myserver.org
          locations:
            - location: /
              proxy_to: http://gitlab/
        harbor_ui:
          https: false
          upstreams:
            harbor_ui: "172.17.0.1:50080"
            harbor_registry: "172.17.0.1:55000"
          server_name: my.harbor.org
          locations:
            - location: /
              proxy_to: http://harbor_ui/
            - location: /v1/
              returns: 404
            - location: /v2/
              proxy_to: http://harbor_registry/v2/
            - location: /service/
              proxy_to: http://harbor_ui/service/
            - location: /service/notifications
              returns: 404
